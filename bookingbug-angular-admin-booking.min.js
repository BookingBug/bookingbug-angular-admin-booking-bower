(function(){"use strict";var adminbookingapp;adminbookingapp=angular.module("BBAdminBooking",["BB","BBAdmin.Services","trNgGrid"]),angular.module("BBAdminBooking").config(function($logProvider){return $logProvider.debugEnabled(!0)}),angular.module("BBAdminBooking.Directives",[]),angular.module("BBAdminBooking.Services",["ngResource","ngSanitize","ngLocalData"]),angular.module("BBAdminBooking.Controllers",["ngLocalData","ngSanitize"]),adminbookingapp.run(function($rootScope,$log,DebugUtilsService,FormDataStoreService,$bbug,$document,$sessionStorage,AppConfig,AdminLoginService){return AdminLoginService.checkLogin().then(function(){return $rootScope.user&&$rootScope.user.company_id?($rootScope.bb||($rootScope.bb={}),$rootScope.bb.company_id=$rootScope.user.company_id):void 0})})}).call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;window.Collection.Client=function(superClass){function Client(){return Client.__super__.constructor.apply(this,arguments)}return extend(Client,superClass),Client.prototype.checkItem=function(item){return Client.__super__.checkItem.apply(this,arguments)},Client}(window.Collection.Base),angular.module("BB.Services").provider("ClientCollections",function(){return{$get:function(){return new window.BaseCollections}}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("calendarAdmin",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"calendarAdminCtrl"}}),angular.module("BB.Controllers").controller("calendarAdminCtrl",function($scope,$element,$controller,$attrs,$modal,BBModel){return $scope.adult_count=0,$scope.show_child_qty=!1,$scope.show_price=!1,angular.extend(this,$controller("TimeList",{$scope:$scope,$attrs:$attrs,$element:$element})),$scope.week_view=!1,$scope.name_switch="switch to week view",$scope.switchWeekView=function(){return $scope.week_view?($scope.week_view=!1,$scope.name_switch="switch to day view"):($scope.week_view=!0,$scope.name_switch="switch to week view")},$scope.bookAnyway=function(){return $scope.new_timeslot=new BBModel.TimeSlot({time:$scope.current_item.defaults.time,avail:1}),$scope.selectSlot($scope.new_timeslot)}})}.call(this),function(){"use strict";angular.module("BBAdminBooking").directive("bbAdminBookingClients",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"adminBookingClients"}}),angular.module("BBAdminBooking").controller("adminBookingClients",function($scope,$rootScope,$q,AdminClientService,ClientDetailsService,AlertService,ClientService,ValidatorService,ErrorService,$log,PaginationService){return $scope.validator=ValidatorService,$scope.clientDef=$q.defer(),$scope.clientPromise=$scope.clientDef.promise,$scope.per_page=20,$scope.total_entries=0,$scope.clients=[],$scope.search_clients=!1,$scope.newClient=!1,$scope.no_clients=!1,$scope.search_error=!1,$scope.search_text=null,$scope.pagination=PaginationService.initialise({page_size:10,max_size:5}),$scope.showSearch=function(_this){return function(){return $scope.search_clients=!0,$scope.newClient=!1}}(this),$scope.showClientForm=function(_this){return function(){return $scope.search_error=!1,$scope.no_clients=!1,$scope.search_clients=!1,$scope.newClient=!0,$scope.clearClient()}}(this),$scope.selectClient=function(_this){return function(client,route){return $scope.search_error=!1,$scope.no_clients=!1,$scope.setClient(client),$scope.client.setValid(!0),$scope.decideNextPage(route)}}(this),$scope.checkSearch=function(_this){return function(){return $scope.search_text&&$scope.search_text.length>=3?($scope.search_error=!1,!0):($scope.search_error=!0,!1)}}(this),$scope.createClient=function(_this){return function(route){return $scope.notLoaded($scope),$scope.bb&&$scope.bb.parent_client&&($scope.client.parent_client_id=$scope.bb.parent_client.id),$scope.client_details&&$scope.client.setClientDetails($scope.client_details),ClientService.create_or_update($scope.bb.company,$scope.client).then(function(client){return $scope.setLoaded($scope),$scope.selectClient(client,route)},function(err){return $scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),$scope.getClients=function(currentPage,filterBy,filterByFields,orderBy,orderByReverse){var clientDef,params;return AlertService.clear(),$scope.search_triggered=!0,$scope.no_clients=!1,$scope.search_error=!1,clientDef=$q.defer(),params={company:$scope.bb.company,per_page:$scope.per_page,filter_by:null!=filterBy?filterBy:$scope.search_text,filter_by_fields:filterByFields,order_by:orderBy,order_by_reverse:orderByReverse},currentPage&&(params.page=currentPage+1),$scope.notLoaded($scope),!$rootScope.bb.api_url&&$scope.bb.api_url&&($rootScope.bb.api_url=$scope.bb.api_url),AdminClientService.query(params).then(function(_this){return function(clients){return $scope.clients=clients.items,$scope.setLoaded($scope),$scope.setPageLoaded(),$scope.total_entries=clients.total_entries,PaginationService.update($scope.pagination,$scope.clients.length),clientDef.resolve(clients.items)}}(this))},$scope.searchClients=function(search_text){var clientDef,params;return clientDef=$q.defer(),params={filter_by:search_text,company:$scope.bb.company},AdminClientService.query(params).then(function(_this){return function(clients){return clientDef.resolve(clients.items),clients.items}}(this)),clientDef.promise},$scope.typeHeadResults=function($item,$model,$label){var item,label,model;item=$item,model=$model,label=$label,$scope.client=item},$scope.clearSearch=function(){return $scope.clients=null,$scope.search_triggered=!1},$scope.edit=function(item){return $log.info("not implemented")}})}.call(this),function(){angular.module("BBAdminBooking").directive("bbAdminBooking",function(AdminCompanyService,$log,$compile,$q,PathSvc,$templateCache,$http){var getTemplate,link,renderTemplate;return getTemplate=function(template){var fromTemplateCache,partial,src;return partial=template?template:"main",fromTemplateCache=$templateCache.get(partial),fromTemplateCache?fromTemplateCache:(src=PathSvc.directivePartial(partial).$$unwrapTrustedValue(),$http.get(src,{cache:$templateCache}).then(function(response){return response.data}))},renderTemplate=function(scope,element,design_mode,template){return $q.when(getTemplate(template)).then(function(template){return element.html(template).show(),design_mode&&element.append("<style widget_css scoped></style>"),$compile(element.contents())(scope)})},link=function(scope,element,attrs){var config;return config=scope.$eval(attrs.bbAdminBooking),config||(config={}),config.admin=!0,attrs.companyId||(config.company_id?attrs.companyId=config.company_id:scope.company&&(attrs.companyId=scope.company.id)),attrs.companyId?AdminCompanyService.query(attrs).then(function(company){return scope.company=company,scope.initWidget(config),renderTemplate(scope,element,config.design_mode,config.template)}):void 0},{link:link,controller:"BBCtrl"}})}.call(this),function(){angular.module("BBAdminBooking").directive("bbAdminBookingPopup",function(AdminBookingPopup){var controller,link;return controller=function($scope){return $scope.open=function(){return AdminBookingPopup.open()}},link=function(scope,element,attrs){return element.bind("click",function(){return scope.open()})},{link:link,controller:controller}})}.call(this),function(){angular.module("BBAdminBooking").directive("bbBlockTime",function(){return{scope:!0,restrict:"A",controller:function($scope,$element,$attrs,AdminPersonService,uiCalendarConfig){var blockSuccess,isValid;return $scope.resources=[],$scope.bb.current_item.company.$has("people")&&$scope.bb.current_item.company.getPeoplePromise().then(function(people){var i,len,p;for(i=0,len=people.length;len>i;i++)p=people[i],p.title=p.name,p.identifier=p.id+"_p",p.group="Staff";return $scope.resources=_.union($scope.resources,people)}),$scope.bb.current_item.company.$has("resources")&&$scope.bb.current_item.company.getResourcesPromise().then(function(resources){var i,len,r;for(i=0,len=resources.length;len>i;i++)r=resources[i],r.title=r.name,r.identifier=r.id+"_r",r.group="Resources ";return $scope.resources=_.union($scope.resources,resources)}),null!=$scope.bb.current_item.person&&null!=$scope.bb.current_item.person.id&&($scope.picked_resource=$scope.bb.current_item.person.id+"_p"),null!=$scope.bb.current_item.resource&&null!=$scope.bb.current_item.resource.id&&($scope.picked_resource=$scope.bb.current_item.resource.id+"_r"),$scope.changeResource=function(){var parts;return null!=$scope.picked_resource?($scope.resourceError=!1,parts=$scope.picked_resource.split("_"),angular.forEach($scope.resources,function(value,key){value.identifier===$scope.picked_resource&&("p"===parts[1]?$scope.bb.current_item.person=value:"r"===parts[1]&&($scope.bb.current_item.resource=value))})):void 0},$scope.blockTime=function(){return isValid()?"object"==typeof $scope.bb.current_item.person?AdminPersonService.block($scope.bb.company,$scope.bb.current_item.person,{start_time:$scope.config.from_datetime,end_time:$scope.config.to_datetime}).then(function(response){return blockSuccess()}):"object"==typeof $scope.bb.current_item.resource?AdminResourceService.block($scope.bb.company,$scope.bb.current_item.person,{start_time:$scope.config.from_datetime,end_time:$scope.config.to_datetime}).then(function(response){return blockSuccess()}):void 0:!1},isValid=function(){return $scope.resourceError=!1,"object"!=typeof $scope.bb.current_item.person&&"object"!=typeof $scope.bb.current_item.resource&&($scope.resourceError=!0),("object"==typeof $scope.bb.current_item.person||"object"==typeof $scope.bb.current_item.resource)&&null!=$scope.config.from_datetime&&$scope.config.to_datetime},blockSuccess=function(){return uiCalendarConfig.calendars.resourceCalendar.fullCalendar("refetchEvents"),$scope.cancel()}}}})}.call(this),function(){angular.module("BBAdminBooking").directive("bbDateTimePicker",function(PathSvc){return{scope:{date:"=",showMeridian:"=?",minuteStep:"=?"},restrict:"A",templateUrl:function(element,attrs){return PathSvc.directivePartial("_datetime_picker")},controller:function($scope,$filter,$timeout,GeneralOptions){return $scope.minuteStep&&"undefined"!=typeof $scope.minuteStep||($scope.minuteStep=GeneralOptions.calendar_minute_step),$scope.showMeridian&&"undefined"!=typeof $scope.showMeridian||($scope.showMeridian=GeneralOptions.twelve_hour_format),$scope.$watch("datetimeWithNoTz",function(newValue,oldValue){var assembledDate;newValue=new Date(newValue),null!=newValue&&moment(newValue).isValid()&&(assembledDate=moment(),assembledDate.set({year:parseInt(newValue.getFullYear()),month:parseInt(newValue.getMonth()),date:parseInt(newValue.getDate()),hour:parseInt(newValue.getHours()),minute:parseInt(newValue.getMinutes()),second:0}),$scope.date=assembledDate.format())}),$scope.datetimeWithNoTz=$filter("clearTimezone")(moment($scope.date).format())}}})}.call(this),function(){angular.module("BBAdminBooking").factory("AdminBookingPopup",function($modal,$timeout){return{open:function(config){return $modal.open({size:"lg",controller:function($scope,$modalInstance,config,$window){var base;return $scope.Math=$window.Math,$scope.bb&&$scope.bb.current_item&&delete $scope.bb.current_item,$scope.config=angular.extend({clear_member:!0,template:"main"},config),$scope.company&&((base=$scope.config).company_id||(base.company_id=$scope.company.id)),$scope.config.item_defaults=angular.extend({merge_resources:!0,merge_people:!1},config.item_defaults),$scope.cancel=function(){return $modalInstance.dismiss("cancel")}},templateUrl:"admin_booking_popup.html",resolve:{config:function(){return config}}})}}})}.call(this),function(){angular.module("BBAdminBooking").provider("GeneralOptions",[function(){var options;options={twelve_hour_format:!1,calendar_minute_step:10},this.setOption=function(option,value){options.hasOwnProperty(option)&&(options[option]=value)},this.$get=function(){return options}}])}.call(this);