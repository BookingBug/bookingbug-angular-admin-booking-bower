(function(){"use strict";var adminbookingapp;adminbookingapp=angular.module("BBAdminBooking",["BB","BBAdmin.Services","trNgGrid"]),angular.module("BBAdminBooking").config(function($logProvider){return $logProvider.debugEnabled(!0)}),angular.module("BBAdminBooking.Directives",[]),angular.module("BBAdminBooking.Services",["ngResource","ngSanitize","ngLocalData"]),angular.module("BBAdminBooking.Controllers",["ngLocalData","ngSanitize"]),adminbookingapp.run(function($rootScope,$log,DebugUtilsService,FormDataStoreService,$bbug,$document,$sessionStorage,AppConfig,AdminLoginService){return AdminLoginService.checkLogin().then(function(){return $rootScope.user&&$rootScope.user.company_id?($rootScope.bb||($rootScope.bb={}),$rootScope.bb.company_id=$rootScope.user.company_id):void 0})})}).call(this),function(){var extend=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;window.Collection.Client=function(superClass){function Client(){return Client.__super__.constructor.apply(this,arguments)}return extend(Client,superClass),Client.prototype.checkItem=function(item){return Client.__super__.checkItem.apply(this,arguments)},Client}(window.Collection.Base),angular.module("BB.Services").provider("ClientCollections",function(){return{$get:function(){return new window.BaseCollections}}})}.call(this),function(){"use strict";angular.module("BB.Directives").directive("bbAdminCalendar",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"adminCalendarCtrl"}}),angular.module("BB.Controllers").controller("adminCalendarCtrl",function($scope,$element,$controller,$attrs,$modal,BBModel,$rootScope){return angular.extend(this,$controller("TimeList",{$scope:$scope,$attrs:$attrs,$element:$element})),$scope.calendar_view={next_available:!1,day:!1,multi_day:!1},$rootScope.connection_started.then(function(){return $scope.initialise()}),$scope.initialise=function(){return $scope.bb.item_defaults.pick_first_time?$scope.switchView("next_available"):null!=$scope.bb.current_item.defaults.time?$scope.switchView("day"):$scope.switchView("multi_day"),$scope.bb.current_item.person&&($scope.person_name=$scope.bb.current_item.person.name),$scope.bb.current_item.resource?$scope.resource_name=$scope.bb.current_item.resource.name:void 0},$scope.switchView=function(view){var key,ref,value;ref=$scope.calendar_view;for(key in ref)value=ref[key],$scope.calendar_view[key]=!1;return $scope.calendar_view[view]=!0},$scope.overBook=function(){var new_day,new_timeslot;return new_timeslot=new BBModel.TimeSlot({time:$scope.bb.current_item.defaults.time,avail:1}),new_day=new BBModel.Day({date:$scope.bb.current_item.defaults.datetime,spaces:1}),$scope.setLastSelectedDate(new_day.date),$scope.bb.current_item.setDate(new_day),$scope.bb.current_item.setTime(new_timeslot),$scope.bb.current_item.setPerson($scope.bb.current_item.defaults.person),$scope.bb.current_item.setResource($scope.bb.current_item.defaults.resource),$scope.bb.current_item.reserve_ready?$scope.addItemToBasket().then(function(_this){return function(){return $scope.decideNextPage()}}(this)):void 0}})}.call(this),function(){"use strict";angular.module("BBAdminBooking").directive("bbAdminBookingClients",function(){return{restrict:"AE",replace:!0,scope:!0,controller:"adminBookingClients"}}),angular.module("BBAdminBooking").controller("adminBookingClients",function($scope,$rootScope,$q,AdminClientService,AlertService,ClientService,ValidatorService,ErrorService,$log,BBModel,$timeout){return $scope.validator=ValidatorService,$scope.clients=new BBModel.Pagination({page_size:10,max_size:5,request_page_size:10}),$scope.sort_by_options=[{key:"first_name",name:"First Name"},{key:"last_name",name:"Last Name"},{key:"email",name:"Email"}],$scope.sort_by=$scope.sort_by_options[0].key,$rootScope.connection_started.then(function(){return $scope.clearClient()}),$scope.selectClient=function(_this){return function(client,route){return $scope.setClient(client),$scope.client.setValid(!0),$scope.decideNextPage(route)}}(this),$scope.createClient=function(_this){return function(route){return $scope.notLoaded($scope),$scope.bb&&$scope.bb.parent_client&&($scope.client.parent_client_id=$scope.bb.parent_client.id),$scope.client_details&&$scope.client.setClientDetails($scope.client_details),ClientService.create_or_update($scope.bb.company,$scope.client).then(function(client){return $scope.setLoaded($scope),$scope.selectClient(client,route)},function(err){return err.data&&"Please Login"===err.data.error?($scope.setLoaded($scope),AlertService.raise("EMAIL_ALREADY_REGISTERED_ADMIN")):err.data&&"Sorry, it appears that this phone number already exists"===err.data.error?($scope.setLoaded($scope),AlertService.raise("PHONE_NUMBER_ALREADY_REGISTERED_ADMIN")):$scope.setLoadedAndShowError($scope,err,"Sorry, something went wrong")})}}(this),$scope.getClients=function(params,options){return null==options&&(options={}),$scope.search_triggered=!0,$timeout(function(){return $scope.search_triggered=!1},1e3),!params||params&&!params.filter_by?void 0:($scope.params={company:params.company||$scope.bb.company,per_page:params.per_page||$scope.clients.request_page_size,filter_by:params.filter_by,search_by_fields:params.search_by_fields||"phone,mobile",order_by:params.order_by||$scope.sort_by,order_by_reverse:params.order_by_reverse,page:params.page||1},$scope.notLoaded($scope),AdminClientService.query($scope.params).then(function(result){return $scope.search_complete=!0,options.add?$scope.clients.add(params.page,result.items):$scope.clients.initialise(result.items,result.total_entries),$scope.setLoaded($scope)}))},$scope.searchClients=function(search_text){var defer,params;return defer=$q.defer(),params={filter_by:search_text,company:$scope.bb.company},AdminClientService.query(params).then(function(_this){return function(clients){return defer.resolve(clients.items),clients.items}}(this)),defer.promise},$scope.typeHeadResults=function($item,$model,$label){var item,label,model;return item=$item,model=$model,label=$label,$scope.client=item,$scope.selectClient($item)},$scope.clearSearch=function(){return $scope.clients.initialise(),$scope.typehead_result=null,$scope.search_complete=!1},$scope.edit=function(item){return $log.info("not implemented")},$scope.pageChanged=function(){var items_present,page_to_load,ref;return ref=$scope.clients.update(),items_present=ref[0],page_to_load=ref[1],items_present?void 0:($scope.params.page=page_to_load,$scope.getClients($scope.params,{add:!0}))},$scope.sortChanged=function(sort_by){return $scope.params.order_by=sort_by,$scope.params.page=1,$scope.getClients($scope.params)}})}.call(this),function(){angular.module("BB.Filters").filter("in_the_future",function(){return function(slots){var now_tod,tim;return tim=moment(),now_tod=tim.minutes()+60*tim.hours(),_.filter(slots,function(x){return x.time>now_tod})}}),angular.module("BB.Filters").filter("tod_from_now",function(){return function(tod,options){var hour_string,hours,min_string,mins,now_tod,seperator,str,tim,v,val;return tim=moment(),now_tod=tim.minutes()+60*tim.hours(),v=tod-now_tod,hour_string=options&&options.abbr_units?"hr":"hour",min_string=options&&options.abbr_units?"min":"minute",seperator=options&&angular.isString(options.seperator)?options.seperator:"and",val=parseInt(v),60>val?val+" "+min_string+"s":(hours=parseInt(val/60),mins=val%60,0===mins?1===hours?"1 "+hour_string:hours+" "+hour_string+"s":(str=hours+" "+hour_string,hours>1&&(str+="s"),0===mins?str:(seperator.length>0&&(str+=" "+seperator),str+=" "+mins+" "+min_string+"s")))}})}.call(this),function(){angular.module("BBAdminBooking").directive("bbAdminBooking",function(AdminCompanyService,$log,$compile,$q,PathSvc,$templateCache,$http){var getTemplate,link,renderTemplate;return getTemplate=function(template){var fromTemplateCache,partial,src;return partial=template?template:"main",fromTemplateCache=$templateCache.get(partial),fromTemplateCache?fromTemplateCache:(src=PathSvc.directivePartial(partial).$$unwrapTrustedValue(),$http.get(src,{cache:$templateCache}).then(function(response){return response.data}))},renderTemplate=function(scope,element,design_mode,template){return $q.when(getTemplate(template)).then(function(template){return element.html(template).show(),design_mode&&element.append("<style widget_css scoped></style>"),$compile(element.contents())(scope)})},link=function(scope,element,attrs){var config;return config=scope.$eval(attrs.bbAdminBooking),config||(config={}),config.admin=!0,attrs.companyId||(config.company_id?attrs.companyId=config.company_id:scope.company&&(attrs.companyId=scope.company.id)),attrs.companyId?AdminCompanyService.query(attrs).then(function(company){return scope.company=company,scope.initWidget(config),renderTemplate(scope,element,config.design_mode,config.template)}):void 0},{link:link,controller:"BBCtrl"}})}.call(this),function(){angular.module("BBAdminBooking").directive("bbAdminBookingPopup",function(AdminBookingPopup){return{restrict:"A",link:function(scope,element,attrs){return element.bind("click",function(){return scope.open()})},controller:function($scope){return $scope.open=function(){return AdminBookingPopup.open()}}}})}.call(this),function(){angular.module("BBAdminBooking").directive("bbBlockTime",function(){return{scope:!0,restrict:"A",controller:function($scope,$element,$attrs,AdminPersonService,AdminResourceService,BBModel,BookingCollections,$rootScope,BBAssets){var blockSuccess,isValid;return $scope.resources=[],BBAssets($scope.bb.company).then(function(assets){return $scope.resources=assets}),moment.isMoment($scope.config.to_datetime)||($scope.config.to_datetime=moment($scope.config.to_datetime)),moment.isMoment($scope.config.from_datetime)||($scope.config.from_datetime=moment($scope.config.from_datetime)),$scope.hideBlockAllDay=Math.abs($scope.config.from_datetime.diff($scope.config.to_datetime,"days"))>0,null!=$scope.bb.current_item.person&&null!=$scope.bb.current_item.person.id&&($scope.picked_resource=$scope.bb.current_item.person.id+"_p"),null!=$scope.bb.current_item.resource&&null!=$scope.bb.current_item.resource.id&&($scope.picked_resource=$scope.bb.current_item.resource.id+"_r"),$scope.changeResource=function(){var parts;return null!=$scope.picked_resource?($scope.resourceError=!1,parts=$scope.picked_resource.split("_"),angular.forEach($scope.resources,function(value,key){value.identifier===$scope.picked_resource&&("p"===parts[1]?$scope.bb.current_item.person=value:"r"===parts[1]&&($scope.bb.current_item.resource=value))})):void 0},$scope.blockTime=function(){return isValid()?"object"==typeof $scope.bb.current_item.person?AdminPersonService.block($scope.bb.company,$scope.bb.current_item.person,{start_time:$scope.config.from_datetime,end_time:$scope.config.to_datetime,booking:!0}).then(function(response){return blockSuccess(response)}):"object"==typeof $scope.bb.current_item.resource?AdminResourceService.block($scope.bb.company,$scope.bb.current_item.person,{start_time:$scope.config.from_datetime,end_time:$scope.config.to_datetime,booking:!0}).then(function(response){return blockSuccess(response)}):void 0:!1},isValid=function(){return $scope.resourceError=!1,"object"!=typeof $scope.bb.current_item.person&&"object"!=typeof $scope.bb.current_item.resource&&($scope.resourceError=!0),("object"==typeof $scope.bb.current_item.person||"object"==typeof $scope.bb.current_item.resource)&&null!=$scope.config.from_datetime&&$scope.config.to_datetime},blockSuccess=function(response){return $rootScope.$broadcast("refetchBookings"),$scope.cancel()},$scope.changeBlockDay=function(blockDay){return blockDay?($scope.config.from_datetime=$scope.config.min_date.format(),$scope.config.to_datetime=$scope.config.max_date.format()):void 0}}}})}.call(this),function(){angular.module("BB.Services").provider("AdminBookingOptions",[function(){var options;options={merge_resources:!0,merge_people:!0},this.setOption=function(option,value){options.hasOwnProperty(option)&&(options[option]=value)},this.$get=function(){return options}}])}.call(this),function(){angular.module("BBAdminBooking").factory("AdminBookingPopup",function($modal,$timeout){return{open:function(config){return $modal.open({size:"lg",controller:function($scope,$modalInstance,config,$window,AdminBookingOptions){var base;return $scope.Math=$window.Math,$scope.bb&&$scope.bb.current_item&&delete $scope.bb.current_item,$scope.config=angular.extend({clear_member:!0,template:"main"},config),$scope.company&&((base=$scope.config).company_id||(base.company_id=$scope.company.id)),$scope.config.item_defaults=angular.extend({merge_resources:AdminBookingOptions.merge_resources,merge_people:AdminBookingOptions.merge_people},config.item_defaults),$scope.cancel=function(){return $modalInstance.dismiss("cancel")}},templateUrl:"admin_booking_popup.html",resolve:{config:function(){return config}}})}}})}.call(this),function(){angular.module("BBAdminBooking").factory("BBAssets",["$q",function($q){return function(company){var assets,delay,promises;return delay=$q.defer(),promises=[],assets=[],company.$has("people")&&promises.push(company.getPeoplePromise().then(function(people){var i,len,p;for(i=0,len=people.length;len>i;i++)p=people[i],p.title=p.name,p.identifier=p.id+"_p",p.group="Staff";return assets=_.union(assets,people)})),company.$has("resources")&&promises.push(company.getResourcesPromise().then(function(resources){var i,len,r;for(i=0,len=resources.length;len>i;i++)r=resources[i],r.title=r.name,r.identifier=r.id+"_r",r.group="Resources ";return assets=_.union(assets,resources)})),$q.all(promises).then(function(){return assets=_.sortBy(assets,"name"),delay.resolve(assets)}),delay.promise}}])}.call(this),function(){angular.module("BBAdminBooking").factory("ProcessAssetsFilter",[function(){return function(string){var assets;return assets=[],"undefined"==typeof string||""===string?assets:angular.forEach(string.split(","),function(value){return assets.push(parseInt(decodeURIComponent(value)))})}}])}.call(this);